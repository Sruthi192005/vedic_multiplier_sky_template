name: gds
on:
  push:
  workflow_dispatch:
jobs:
  gds:
    runs-on: ubuntu-24.04
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build GDS
        uses: TinyTapeout/tt-gds-action@ttsky25a
        with:
          pdk: sky130
          tools-ref: ttsky25a
  precheck:
    needs: gds
    runs-on: ubuntu-24.04
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Run Tiny Tapeout Precheck
        uses: TinyTapeout/tt-gds-action/precheck@ttsky25a
        with:
          pdk: sky130
          tools-ref: ttsky25a
  gl_test:
    needs: gds
    runs-on: ubuntu-24.04
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: GL test
        uses: TinyTapeout/tt-gds-action/gl_test@ttsky25a
        with:
          pdk: sky130
          tools-ref: ttsky25a
  pages:
    needs: gds
    runs-on: ubuntu-24.04
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Generate Viewer
        uses: TinyTapeout/tt-gds-action/viewer@ttsky25a
        with:
          pdk: sky130
          tools-ref: ttsky25a
      - name: Setup Pages
        uses: actions/configure-pages@v4
      - name: Prepare viewer files
        run: |
          echo "Current directory contents:"
          ls -la
          
          # Create a pages directory for deployment
          mkdir -p _site
          
          # Look for generated viewer files
          if [ -d "viewer" ]; then
            echo "Found viewer directory, copying contents"
            cp -r viewer/* _site/
          elif [ -f "index.html" ]; then
            echo "Found index.html in root, copying to _site"
            cp *.html _site/ 2>/dev/null || true
            cp -r assets _site/ 2>/dev/null || true
            cp -r css _site/ 2>/dev/null || true
            cp -r js _site/ 2>/dev/null || true
          else
            echo "No viewer files found, creating placeholder"
            echo "<html><head><title>GDS Viewer</title></head><body><h1>GDS Layout Viewer</h1><p>No viewer files were generated.</p></body></html>" > _site/index.html
          fi
          
          echo "Contents of _site directory:"
          ls -la _site/
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
